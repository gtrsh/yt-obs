generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  ADMIN
}

enum ChannelStatus {
  PENDING // только создан, ждёт проверки
  UPDATING // получение новых данных, существующего канала
  ACTIVE // канал существует, данные получены
  NOT_FOUND // канал не найден на YouTube
  ERROR // ошибка при получении данных
}

enum TaskType {
  CREATE // первичное получение данных
  UPDATE // обновление списка видео
}

enum TaskStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model User {
  id       String  @id @default(uuid(7)) @db.Uuid
  role     Role    @default(USER)
  name     String  @unique
  email    String? @unique
  password String

  channels UserChannel[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("user")
}

model Channel {
  id     String        @id @default(uuid(7)) @db.Uuid
  url    String        @unique
  status ChannelStatus @default(PENDING)

  info  ChannelInfo?
  data  ChannelData[]
  tasks ChannelTask[]
  users UserChannel[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([url, status])
  @@map("channel")
}

model ChannelInfo {
  id   String @id @default(uuid(7)) @db.Uuid
  info Json?  @db.JsonB

  channelId String  @unique @map("channel_id") @db.Uuid
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("channel_info")
}

model ChannelData {
  id           String  @id @default(uuid(7)) @db.Uuid
  data         Json?   @db.JsonB
  playlistType String? @map("playlist_type")
  isCurrent    Boolean @default(false) @map("is_current")

  channelId String  @map("channel_id") @db.Uuid
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  taskId String?      @unique @map("task_id") @db.Uuid
  task   ChannelTask? @relation(fields: [taskId], references: [id], onDelete: SetNull)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([channelId])
  @@map("channel_data")
}

model ChannelTask {
  id     String     @id @default(uuid(7)) @db.Uuid
  type   TaskType
  status TaskStatus @default(PENDING)
  error  String?

  channelId String  @map("channel_id") @db.Uuid
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  resultData ChannelData? // данные, полученные этим таском

  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime? @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  @@index([channelId])
  @@index([status])
  @@map("channel_task")
}

model UserChannel {
  id String @id @default(uuid(7)) @db.Uuid

  userId String @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  channelId String  @map("channel_id") @db.Uuid
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@unique([userId, channelId])
  @@index([userId])
  @@index([channelId])
  @@map("user_channel")
}
